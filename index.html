<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Lively Todo + Calendar + Quotes ‚Äî Routines Enhanced</title>
<style>
:root {
  --bg-dark:#042417; --panel-dark:#083826; --accent-dark:#3fbf76; --muted-dark:#8fcfb0; --card-dark:#0b6a46; --ink-dark:#f8fefb;
  --bg-light:#eaf5ec; --panel-light:#f4fff8; --accent-light:#2e8b57; --muted-light:#9ad8b4; --card-light:#ffffff; --ink-light:#052d18;
  --radius:14px; --shadow:0 6px 18px rgba(0,0,0,0.25);
  font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
}
body[data-theme="dark"]{--bg:var(--bg-dark);--panel:var(--panel-dark);--accent:var(--accent-dark);--muted:var(--muted-dark);--card:var(--card-dark);--ink:var(--ink-dark);}
body[data-theme="light"]{--bg:var(--bg-light);--panel:var(--panel-light);--accent:var(--accent-light);--muted:var(--muted-light);--card:var(--card-light);--ink:var(--ink-light);}

html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);transition:background .35s,color .35s;overflow:hidden;}

/* HEADER */
header{position:fixed;top:0;left:0;width:100%;height:60px;background:var(--panel);display:flex;align-items:center;justify-content:space-evenly;padding:0 20px;box-shadow:var(--shadow);z-index:100;}
header .brand{font-weight:700;font-size:1.2rem;}
.nav-btns{display:flex;gap:8px;flex-wrap:wrap;}
.nav-btns button{padding:8px 14px;border:0;border-radius:10px;background:var(--accent);color:#012b17;cursor:pointer;font-weight:600;transition:0.25s;font-size:0.9rem;}
.nav-btns button:hover{opacity:.9;transform:translateY(-2px);}

/* MAIN LAYOUT */
.main-layout{transition:opacity .4s ease;display:flex;justify-content:space-between;align-items:flex-start;height:calc(100vh - 60px);padding-top:60px;}

/* LEFT: calendar + clock + habits */
.left-panel{display:flex;flex-direction:column;gap:12px;margin-left:20px;margin-top:20px;width:25vw;min-width:240px;}
.calendar{background:var(--panel);border-radius:var(--radius);padding:12px;box-shadow:var(--shadow);}
.calendar table{width:100%;border-collapse:collapse;}
.calendar th,.calendar td{text-align:center;padding:6px;cursor:pointer;transition:all 0.3s ease;}
.calendar td:hover{transform:scale(1.15);background:var(--card);border-radius:50%;}
.calendar td.today{background:linear-gradient(135deg,var(--accent),var(--muted));color:#022a17;border-radius:50%;width:32px;height:32px;display:inline-grid;place-items:center;font-weight:700;}
.calendar td.today:hover{transform:scale(1.2);box-shadow:0 0 12px var(--accent);}
.calendar td.reminder::after{content:"‚Ä¢";display:block;color:var(--accent);margin-top:-2px;}

/* clock */
.clock{background:var(--panel);border-radius:var(--radius);padding:20px;text-align:center;font-size:2.2rem;box-shadow:var(--shadow);}

/* habits box under calendar/clock */
.habits{
  display:flex;flex-direction:column;gap:8px;background:transparent;padding:8px 0;width:100%;
}
.habit-card{background:var(--panel);border-radius:12px;padding:10px;box-shadow:var(--shadow);display:flex;justify-content:space-between;align-items:center;gap:8px;}
.habit-card small{opacity:.85;}
.habit-controls{display:flex;gap:8px;align-items:center;}

/* CENTER: routines (main new feature) */
.center-panel{
  width:30vw;min-width:320px;display:flex;flex-direction:column;gap:12px;align-items:center;justify-content:flex-start;padding-top:20px;
}
.routines-wrap{width:100%;max-width:480px;background:var(--panel);border-radius:var(--radius);padding:14px;box-shadow:var(--shadow);}
.routines-wrap h3{margin:0 0 8px 0;}
.routine-list{display:flex;flex-direction:column;gap:8px;max-height:65.5vh;overflow:auto;padding-right:6px;margin-top:5px;}
.routine-row{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:8px;border-radius:10px;background:var(--card);}
.routine-row .left{display:flex;gap:8px;align-items:center;min-width:0;}
.routine-row .text{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.routine-actions{display:flex;gap:8px;align-items:center;}
.routine-add{display:flex;gap:8px;margin-top:8px;}

/* RIGHT: todo panel (unchanged) */
.todo-panel{width:35vw;max-width:520px;min-width:300px;margin-right:20px;margin-top:20px;background:var(--panel);border-radius:var(--radius);padding:16px;display:flex;flex-direction:column;gap:10px;box-shadow:var(--shadow);}
.todo-list{flex:1;max-height:78vh;overflow:auto;display:flex;flex-direction:column;gap:8px;padding-right:4px;}
.todo{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border-radius:10px;background:var(--card);}
.todo.done .text{text-decoration:line-through;opacity:.6;}
.todo button{border:0;background:none;cursor:pointer;font-size:1rem;}

/* fullscreen modals, keep behavior same */
.fullscreen{position:fixed;top:0;left:0;width:100vw;height:100vh;background:var(--bg);display:flex;align-items:center;justify-content:center;flex-direction:column;z-index:999;transition:opacity .4s ease;opacity:1;}
.fullscreen.hidden{opacity:0;pointer-events:none;}
.fullscreen .exit-btn{position:absolute;top:20px;right:20px;padding:6px 12px;background:var(--accent);color:#012b17;font-weight:700;border:0;border-radius:8px;cursor:pointer;}
.fullscreen .quote{font-size:2.6rem;text-align:center;max-width:80vw;line-height:1.3;font-family:"Poppins",sans-serif;font-weight:600;color:var(--accent);}
.fullscreen .planner{width:90vw;height:80vh;overflow:auto;padding:20px;border-radius:12px;background:var(--panel);box-shadow:var(--shadow);}
.modal{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--panel);padding:16px;border-radius:12px;box-shadow:var(--shadow);z-index:1500;min-width:320px;max-width:90vw;}
.modal h4{margin:0 0 8px 0;}
.modal .close{position:absolute;top:8px;right:8px;border:0;background:none;color:var(--ink);cursor:pointer;font-size:1.1rem;}
.small{font-size:0.85rem;opacity:0.9;}

/* NEW: Pomodoro Mode */
.pomodoro-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:20px;}
.pomodoro-timer{font-size:8rem;font-weight:700;color:var(--accent);text-shadow:0 0 40px var(--accent);}
.pomodoro-controls{display:flex;gap:12px;}
.pomodoro-controls button{padding:12px 24px;border:0;border-radius:12px;background:var(--accent);color:#012b17;font-weight:700;cursor:pointer;font-size:1.1rem;}
.pomodoro-controls button:hover{opacity:.9;}

/* NEW: Stats Mode */
.stats-screen{width:90vw;max-width:1200px;height:85vh;overflow:auto;padding:20px;}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit, minmax(300px, 1fr));gap:20px;margin-top:20px;}
.stat-card{background:var(--panel);border-radius:var(--radius);padding:20px;box-shadow:var(--shadow);max-height:80vh;}
.stat-card h3{margin:0 0 16px 0;color:var(--accent);}
.heatmap{display:grid;grid-template-columns:repeat(7, 1fr);gap:4px;margin-top:12px;}
.heatmap-cell{aspect-ratio:1;border-radius:4px;background:var(--card);cursor:pointer;transition:0.2s;}
.heatmap-cell.level-0{opacity:0.2;}
.heatmap-cell.level-1{opacity:0.4;background:var(--muted);}
.heatmap-cell.level-2{opacity:0.6;background:var(--accent);}
.heatmap-cell.level-3{opacity:0.8;background:var(--accent);}
.heatmap-cell.level-4{opacity:1;background:var(--accent);box-shadow:0 0 8px var(--accent);}

/* NEW: Focus Zone */
.focus-screen{display:flex;width:90vw;max-width:1400px;height:85vh;gap:20px;}
.focus-left{flex:1;background:var(--panel);border-radius:var(--radius);padding:20px;box-shadow:var(--shadow);overflow:auto;}
.focus-right{flex:1;display:flex;flex-direction:column;gap:20px;}
.focus-timer{background:var(--panel);border-radius:var(--radius);padding:30px;box-shadow:var(--shadow);text-align:center;}
.focus-quote{background:var(--panel);border-radius:var(--radius);padding:30px;box-shadow:var(--shadow);display:flex;align-items:center;justify-content:center;font-size:1.8rem;font-weight:600;color:var(--accent);text-align:center;line-height:1.4;}

/* Confetti canvas */
#confetti{position:fixed;top:0;left:0;width:100vw;height:100vh;pointer-events:none;z-index:9999;}
</style>
</head>
<body data-theme="dark">

<canvas id="confetti"></canvas>

<header>
  <div class="brand">üåø Planner Wall by DarinJSE</div>
  <div class="nav-btns">
    <button id="quoteMode">üñºÔ∏è Wallpaper</button>
    <button id="plannerMode">üìÖ Planner</button>
    <button id="historyBtn">üìà History</button>
    <button id="pomodoroBtn">üçÖ Pomodoro</button>
    <button id="statsBtn">üìä Stats</button>
    <button id="focusBtn">üéØ Focus</button>
    <button id="themeToggle">‚òÄÔ∏è / üåô</button>
  </div>
</header>

<div class="main-layout" id="main">
  <!-- LEFT -->
  <div class="left-panel">
    <div class="calendar" id="calendar"></div>
    <div class="clock" id="clock">00:00:00</div>

    <!-- Habits / Streaks under calendar/clock (small) -->
    <div class="habits" id="habitsArea">
      <div class="habit-card">
        <div>
          <div style="font-weight:700">Monthly Overview</div>
          <small id="monthSummary">Loading...</small>
        </div>
        <div class="habit-controls">
          <button id="resetToday" title="Reset today's routine statuses" style="padding:6px 10px;border-radius:8px;border:0;background:var(--accent);color:#012b17;font-weight:700;">Reset Today</button>
        </div>
      </div>
    </div>
  </div>

  <!-- CENTER: Routines -->
  <div class="center-panel">
    <div class="routines-wrap" id="routinesWrap">
      <h3>Rutinitas Harian</h3>
      <div class="small">Tambahin rutinitas DEFAULT, Checklist, reset tiap hari (tetap ada history).</div>

      <div class="routine-list" id="routineList"></div>

      <div class="routine-add">
        <input id="newRoutineInput" placeholder="Nama rutinitas..." style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.08);background:transparent;color:var(--ink)">
        <button id="addRoutineBtn" style="padding:8px 12px;border:0;border-radius:8px;background:var(--accent);color:#012b17;font-weight:700;">Add</button>
      </div>
      <div style="margin-top:8px" class="small">Note: setiap rutinitas punya target bulanan (set di tiap item).</div>
    </div>
  </div>

  <!-- RIGHT: To-do -->
  <aside class="todo-panel">
    <div style="display:flex;gap:8px;">
      <input id="todoInput" placeholder="Tambah tugas..." style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.1);background:transparent;color:var(--ink)">
      <button id="addBtn" style="padding:8px 12px;border:0;border-radius:8px;background:var(--accent);color:#012b17;font-weight:700;">Add</button>
    </div>
    <div id="todoList" class="todo-list"></div>
  </aside>
</div>

<!-- QUOTE MODE -->
<div class="fullscreen hidden" id="quoteScreen">
  <button class="exit-btn" id="exitQuote">‚úñ Kembali</button>
  <div class="quote" id="quoteText">"Klik tombol untuk quote acak"</div>
  <button id="newQuote" style="margin-top:20px;padding:10px 16px;border:0;border-radius:10px;background:var(--accent);color:#012b17;font-weight:700;">üé≤ Quote Baru</button>
</div>

<!-- PLANNER MODE -->
<div class="fullscreen hidden" id="plannerScreen">
  <button class="exit-btn" id="exitPlanner">‚úñ Kembali</button>
  <div class="planner" id="plannerView">
    <h2>üìÜ Semua Rencana</h2>
    <table id="planTable"><thead><tr><th>Tanggal</th><th>Agenda</th></tr></thead><tbody></tbody></table>
  </div>
</div>

<!-- NEW: POMODORO MODE -->
<div class="fullscreen hidden" id="pomodoroScreen">
  <button class="exit-btn" id="exitPomodoro">‚úñ Kembali</button>
  <div class="pomodoro-screen">
    <div style="font-size:2rem;color:var(--muted);margin-bottom:20px;">üçÖ Pomodoro Timer</div>
    <div class="pomodoro-timer" id="pomodoroTimer">25:00</div>
    <div class="pomodoro-controls">
      <button id="pomodoroStart">Start</button>
      <button id="pomodoroPause">Pause</button>
      <button id="pomodoroReset">Reset</button>
    </div>
    <div style="margin-top:20px;font-size:1.2rem;color:var(--muted);" id="pomodoroStatus">Ready to focus</div>
  </div>
</div>

<!-- NEW: STATS MODE -->
<div class="fullscreen hidden" id="statsScreen">
  <button class="exit-btn" id="exitStats">‚úñ Kembali</button>
  <div class="stats-screen">
    <h2 style="color:var(--accent);margin-bottom:20px;">üìä Statistics & Insights</h2>
    <div class="stats-grid">
      <div class="stat-card">
        <h3>üìÖ Routine Heatmap (Last 28 Days)</h3>
        <div class="heatmap" id="heatmap"></div>
      </div>
      <div class="stat-card">
        <h3>üèÜ Top Streaks</h3>
        <div id="topStreaks" style="margin-top:12px;"></div>
      </div>
      <div class="stat-card">
        <h3>üìà Monthly Progress</h3>
        <canvas id="progressChart" width="300" height="200"></canvas>
      </div>
      <div class="stat-card">
        <h3>‚úÖ Completion Rate</h3>
        <div id="completionRate" style="font-size:3rem;font-weight:700;color:var(--accent);text-align:center;margin-top:20px;">0%</div>
      </div>
    </div>
  </div>
</div>

<!-- NEW: FOCUS ZONE MODE -->
<div class="fullscreen hidden" id="focusScreen">
  <button class="exit-btn" id="exitFocus">‚úñ Kembali</button>
  <div class="focus-screen">
    <div class="focus-left">
      <h3 style="color:var(--accent);margin-bottom:16px;">Today's Routines</h3>
      <div id="focusRoutineList"></div>
    </div>
    <div class="focus-right">
      <div class="focus-timer">
        <div style="font-size:1.5rem;color:var(--muted);margin-bottom:10px;">Focus Timer</div>
        <div style="font-size:4rem;font-weight:700;color:var(--accent);" id="focusTimerDisplay">25:00</div>
        <div style="display:flex;gap:10px;justify-content:center;margin-top:20px;">
          <button id="focusStart" style="padding:10px 20px;border:0;border-radius:10px;background:var(--accent);color:#012b17;font-weight:700;">Start</button>
          <button id="focusReset" style="padding:10px 20px;border:0;border-radius:10px;background:var(--card);color:var(--ink);font-weight:700;">Reset</button>
        </div>
      </div>
      <div class="focus-quote" id="focusQuote">
        "Fokus pada progres, bukan kesempurnaan."
      </div>
    </div>
  </div>
</div>

<!-- History / Date modal (reused) -->
<div id="modalRoot" style="pointer-events:none;"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script>
/* ========== UTIL ========== */
function uid(){ return 'id_'+Math.random().toString(36).slice(2,9); }
function todayISO(){ const n=new Date(); return n.toISOString().slice(0,10); }
function monthKey(dateISO){ return dateISO.slice(0,7); }

/* keep previous keys for todos/calendar etc */
const TODO_KEY = 'lively_todos_v3';
const ROUTINES_KEY = 'lively_routines_v1';
const ROUTINE_DAY_PREFIX = 'lively_routines_day_';
const ROUTINE_HISTORY_KEY = 'lively_routines_history_v1';

/* ========== Theme / Todos / Calendar ========== */
const themeBtn=document.getElementById('themeToggle');
if(localStorage.theme) document.body.dataset.theme=localStorage.theme;
themeBtn.onclick=()=>{let cur=document.body.dataset.theme==='dark'?'light':'dark';document.body.dataset.theme=cur;localStorage.theme=cur;};

/* TODOS */
let todos=JSON.parse(localStorage.getItem(TODO_KEY)||'[]');
function saveTodos(){ localStorage.setItem(TODO_KEY,JSON.stringify(todos)); renderTodos(); buildCalendar(); renderPlanner(); }
const listEl=document.getElementById('todoList');
function renderTodos(){
  listEl.innerHTML='';
  todos.forEach((t,i)=>{
    const el=document.createElement('div');
    el.className='todo'+(t.done?' done':'');
    el.innerHTML=`<div class="text">${t.text}</div>
      <div>
        <button data-i="${i}" data-act="done">‚úì</button>
        <button data-i="${i}" data-act="rem">üìÖ</button>
        <button data-i="${i}" data-act="del">üóëÔ∏è</button>
      </div>`;
    listEl.appendChild(el);
  });
}
listEl.addEventListener('click', (e)=>{
  const btn = e.target.closest('button'); if(!btn) return;
  const act = btn.dataset.act, i = Number(btn.dataset.i);
  if(act==='done'){ todos[i].done = !todos[i].done; saveTodos(); }
  else if(act==='del'){ todos.splice(i,1); saveTodos(); }
  else if(act==='rem'){ const d=prompt('Tanggal (YYYY-MM-DD)?', todayISO()); if(d){ todos[i].date=d; saveTodos(); } }
});
document.getElementById('addBtn').onclick=()=>{
  const val=document.getElementById('todoInput').value.trim(); if(!val) return;
  todos.unshift({id:uid(),text:val,done:false}); document.getElementById('todoInput').value=''; saveTodos();
};

/* CALENDAR */
function buildCalendar(){
  const cal=document.getElementById('calendar');
  const now=new Date(), y=now.getFullYear(), m=now.getMonth();
  const first=new Date(y,m,1), last=new Date(y,m+1,0);
  let html=`<div style="font-weight:700;margin-bottom:6px;">${now.toLocaleString('id-ID',{month:'long',year:'numeric'})}</div><table><thead><tr>`;
  ['Min','Sen','Sel','Rab','Kam','Jum','Sab'].forEach(d=>html+=`<th>${d}</th>`); html+='</tr></thead><tbody><tr>';
  for(let i=0;i<first.getDay();i++) html+='<td></td>';
  for(let d=1; d<=last.getDate(); d++){
    const dateStr=`${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const hasRem = todos.some(t=>t.date===dateStr);
    const isToday = d===now.getDate();
    html += `<td data-date="${dateStr}" class="${isToday?'today':''} ${hasRem?'reminder':''}">${d}</td>`;
    if((first.getDay()+d)%7===0) html += '</tr><tr>';
  }
  html += '</tr></tbody></table>';
  cal.innerHTML = html;

  cal.querySelectorAll('td[data-date]').forEach(td=>{
    td.addEventListener('click', ()=>{ showDatePlans(td.dataset.date); });
  });
}

/* clock */
function tick(){ const n=new Date(); document.getElementById('clock').textContent = n.toTimeString().slice(0,8); }
setInterval(tick,1000); tick();

/* FULLSCREEN toggles */
const quoteScreen=document.getElementById('quoteScreen');
const plannerScreen=document.getElementById('plannerScreen');
const pomodoroScreen=document.getElementById('pomodoroScreen');
const statsScreen=document.getElementById('statsScreen');
const focusScreen=document.getElementById('focusScreen');
const main=document.getElementById('main');

function hideAll(){
  [quoteScreen, plannerScreen, pomodoroScreen, statsScreen, focusScreen].forEach(s=>s.classList.add('hidden'));
  main.style.opacity='1';
}

document.getElementById('quoteMode').onclick=()=>{ hideAll(); quoteScreen.classList.remove('hidden'); main.style.opacity='0'; pickQuote(); };
document.getElementById('plannerMode').onclick=()=>{ hideAll(); plannerScreen.classList.remove('hidden'); main.style.opacity='0'; renderPlanner(); };
document.getElementById('pomodoroBtn').onclick=()=>{ hideAll(); pomodoroScreen.classList.remove('hidden'); main.style.opacity='0'; };
document.getElementById('statsBtn').onclick=()=>{ hideAll(); statsScreen.classList.remove('hidden'); main.style.opacity='0'; renderStats(); };
document.getElementById('focusBtn').onclick=()=>{ hideAll(); focusScreen.classList.remove('hidden'); main.style.opacity='0'; renderFocusMode(); };

document.getElementById('exitQuote').onclick=hideAll;
document.getElementById('exitPlanner').onclick=hideAll;
document.getElementById('exitPomodoro').onclick=hideAll;
document.getElementById('exitStats').onclick=hideAll;
document.getElementById('exitFocus').onclick=hideAll;

/* Quotes */
const quotes=[
 "Fokus pada progres, bukan kesempurnaan.",
 "Setiap langkah kecil berarti.",
 "Hari ini waktunya mulai, bukan besok.",
 "Kamu cukup, dan bisa lebih.",
 "Ambil napas, lanjut lagi.",
 "Tujuan besar dimulai dari tugas kecil."
];
function pickQuote(){ 
  const q = quotes[Math.floor(Math.random()*quotes.length)];
  document.getElementById('quoteText').textContent = q;
  document.getElementById('focusQuote').textContent = q;
}
document.getElementById('newQuote').onclick=pickQuote;

/* Planner view */
function renderPlanner(){
  const tbody=document.querySelector('#planTable tbody');
  tbody.innerHTML='';
  todos.filter(t=>t.date).sort((a,b)=>a.date.localeCompare(b.date))
    .forEach(t=>{
      const row=document.createElement('tr');
      row.innerHTML=`<td>${t.date}</td><td>${t.text}${t.done?' ‚úÖ':''}</td>`;
      tbody.appendChild(row);
    });
}

/* ========== Routines logic ========== */
function loadRoutines(){ return JSON.parse(localStorage.getItem(ROUTINES_KEY) || '[]'); }
function saveRoutines(arr){ localStorage.setItem(ROUTINES_KEY, JSON.stringify(arr)); }

function loadRoutineDay(dateISO){
  return JSON.parse(localStorage.getItem(ROUTINE_DAY_PREFIX + dateISO) || '{}');
}
function saveRoutineDay(dateISO, obj){
  localStorage.setItem(ROUTINE_DAY_PREFIX + dateISO, JSON.stringify(obj));
}

function loadRoutineHistory(){ return JSON.parse(localStorage.getItem(ROUTINE_HISTORY_KEY) || '{}'); }
function saveRoutineHistory(h){ localStorage.setItem(ROUTINE_HISTORY_KEY, JSON.stringify(h)); }

function archiveDay(dateISO){
  const statuses = loadRoutineDay(dateISO);
  if(!statuses || Object.keys(statuses).length===0) return;
  const history = loadRoutineHistory();
  const mk = monthKey(dateISO);
  if(!history[mk]) history[mk] = {};
  history[mk][dateISO] = statuses;
  saveRoutineHistory(history);
}

function ensureDailyState(){
  const metaKey = 'lively_routines_meta_v1';
  const meta = JSON.parse(localStorage.getItem(metaKey) || '{}');
  const last = meta.lastDate || null;
  const today = todayISO();
  if(last && last !== today){
    archiveDay(last);
  }
  if(!loadRoutineDay(today)) saveRoutineDay(today, {});
  meta.lastDate = today;
  localStorage.setItem(metaKey, JSON.stringify(meta));
}

function renderRoutinesUI(){
  ensureDailyState();
  const routines = loadRoutines();
  const today = todayISO();
  const dayStatus = loadRoutineDay(today);
  const list = document.getElementById('routineList');
  list.innerHTML = '';
  if(routines.length===0){
    list.innerHTML = '<div class="small">Belum ada rutinitas. Tambah di bawah.</div>';
    updateMonthSummary();
    return;
  }
  routines.forEach((r)=>{
    const row = document.createElement('div');
    row.className = 'routine-row';
    const checked = !!dayStatus[r.id];
    row.innerHTML = `
      <div class="left">
        <input type="checkbox" data-id="${r.id}" ${checked ? 'checked' : ''}>
        <div class="text">${r.text}</div>
      </div>
      <div class="routine-actions small">
        <div>streak: <span data-streak-id="${r.id}">-</span></div>
        <div style="margin-left:8px">target: <input data-target-id="${r.id}" type="number" min="0" value="${r.target||0}" style="width:56px;padding:4px;border-radius:6px"></div>
        <button data-rid="${r.id}" class="delRoutine" title="Hapus" style="padding:6px 8px;border-radius:6px;background:transparent;border:1px solid rgba(0,0,0,0.06);">Del</button>
      </div>
    `;
    list.appendChild(row);
  });

  list.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
    cb.addEventListener('change', (e)=>{
      const id = e.target.dataset.id; const val = e.target.checked;
      const today = todayISO();
      const day = loadRoutineDay(today);
      day[id] = !!val;
      saveRoutineDay(today, day);
      updateMonthSummary(); updateStreaks();
      if(val) triggerConfetti();
    });
  });
  list.querySelectorAll('.delRoutine').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const rid = btn.dataset.rid;
      let arr = loadRoutines();
      arr = arr.filter(x=>x.id!==rid);
      saveRoutines(arr);
      const day = loadRoutineDay(todayISO());
      if(day && day[rid]){ delete day[rid]; saveRoutineDay(todayISO(), day); }
      renderRoutinesUI();
      buildCalendar(); updateMonthSummary();
    });
  });
  list.querySelectorAll('input[data-target-id]').forEach(inp=>{
    inp.addEventListener('change', (e)=>{
      const rid = e.target.dataset.targetId; const v = Number(e.target.value)||0;
      const arr = loadRoutines();
      const it = arr.find(x=>x.id===rid);
      if(it){ it.target = v; saveRoutines(arr); updateMonthSummary(); }
    });
  });

  updateStreaks();
  updateMonthSummary();
}

document.getElementById('addRoutineBtn').onclick=()=>{
  const val=document.getElementById('newRoutineInput').value.trim();
  if(!val) return;
  const arr = loadRoutines();
  arr.push({ id: uid(), text: val, target: 0 });
  saveRoutines(arr);
  document.getElementById('newRoutineInput').value='';
  renderRoutinesUI();
  buildCalendar();
};

function computeStreak(rid){
  const history = loadRoutineHistory();
  const today = todayISO();
  const map = {};
  Object.keys(history).forEach(mon=>{
    Object.keys(history[mon]||{}).forEach(dateISO=> map[dateISO] = history[mon][dateISO]);
  });
  map[today] = loadRoutineDay(today);

  let streak = 0;
  let cur = new Date();
  while(true){
    const dISO = cur.toISOString().slice(0,10);
    const entry = map[dISO];
    if(entry && entry[rid]){ streak++; }
    else break;
    cur.setDate(cur.getDate()-1);
  }
  return streak;
}
function updateStreaks(){
  document.querySelectorAll('[data-streak-id]').forEach(span=>{
    const id = span.getAttribute('data-streak-id');
    span.textContent = computeStreak(id);
  });
}

function updateMonthSummary(){
  const routines = loadRoutines();
  const history = loadRoutineHistory();
  const today = todayISO();
  const mk = monthKey(today);
  const monthData = history[mk] || {};
  const counts = {};
  routines.forEach(r=> counts[r.id] = 0);
  Object.keys(monthData).forEach(d=>{
    const entry = monthData[d];
    Object.keys(entry).forEach(rid=>{ if(entry[rid]) counts[rid] = counts[rid] + 1; });
  });
  const todayStatus = loadRoutineDay(today);
  Object.keys(todayStatus).forEach(rid=>{ if(todayStatus[rid]) counts[rid] = counts[rid] + 1; });

  const parts = routines.map(r=>{
    const c = counts[r.id]||0; const target = r.target||0;
    const remaining = Math.max(0, target - c);
    return `${r.text}: ${c}/${target} (${remaining} left)`;
  });
  document.getElementById('monthSummary').textContent = parts.length ? parts.join(' ‚Ä¢ ') : 'Belum ada rutinitas.';
}

document.getElementById('resetToday').onclick = ()=>{
  const today = todayISO();
  archiveDay(today);
  saveRoutineDay(today, {});
  const metaKey = 'lively_routines_meta_v1';
  const meta = JSON.parse(localStorage.getItem(metaKey) || '{}'); meta.lastDate = today; localStorage.setItem(metaKey, JSON.stringify(meta));
  renderRoutinesUI(); updateMonthSummary(); buildCalendar();
};

function dailyRolloverOnLoad(){
  const metaKey = 'lively_routines_meta_v1';
  const meta = JSON.parse(localStorage.getItem(metaKey) || '{}');
  const last = meta.lastDate || null;
  const today = todayISO();
  if(last && last !== today){
    archiveDay(last);
    saveRoutineDay(today, {});
  } else if(!last){
    saveRoutineDay(today, {});
  }
  meta.lastDate = today; localStorage.setItem(metaKey, JSON.stringify(meta));
}

function showDatePlans(dateISO){
  const plans = todos.filter(t=>t.date===dateISO);
  const root = document.getElementById('modalRoot'); root.style.pointerEvents='auto';
  const modal = document.createElement('div'); modal.className='modal'; modal.id='dateModal';
  modal.innerHTML = `<button class="close" aria-label="close">‚úñ</button>
    <h4>Plans for ${dateISO}</h4>
    <div style="max-height:50vh;overflow:auto;margin-top:8px;" id="modalContent"></div>
    <div style="margin-top:12px;text-align:right;"><button id="closeModal" style="padding:6px 10px;border-radius:8px;border:0;background:var(--accent);color:#012b17;font-weight:700;">Close</button></div>`;
  root.appendChild(modal);

  const content = modal.querySelector('#modalContent');
  if(plans.length===0) content.innerHTML = '<div class="small">Tidak ada todo untuk tanggal ini.</div>';
  else {
    plans.forEach((p, idx)=>{
      const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.gap='8px'; row.style.padding='6px';
      row.innerHTML = `<div style="min-width:0;overflow:hidden;text-overflow:ellipsis;">${p.text}</div>
        <div style="display:flex;gap:8px;">
          <button data-idx="${todos.indexOf(p)}" class="toggleTodo">${p.done ? 'Undo' : 'Done'}</button>
        </div>`;
      content.appendChild(row);
    });
  }

  const dayStatus = (dateISO===todayISO()) ? loadRoutineDay(dateISO) : ( (loadRoutineHistory()[monthKey(dateISO)]||{})[dateISO] || {} );
  const routines = loadRoutines();
  if(routines.length){
    const hr = document.createElement('hr'); hr.style.margin='12px 0'; content.appendChild(hr);
    const title = document.createElement('div'); title.style.fontWeight='700'; title.textContent='Rutinitas (status pada hari ini)';
    content.appendChild(title);
    routines.forEach(r=>{
      const s = dayStatus && dayStatus[r.id] ? '‚úÖ' : '‚óªÔ∏è';
      const el = document.createElement('div'); el.style.display='flex'; el.style.justifyContent='space-between'; el.style.padding='6px';
      el.innerHTML = `<div>${r.text}</div><div>${s}</div>`;
      content.appendChild(el);
    });
  }

  modal.querySelectorAll('.toggleTodo').forEach(b=>{
    b.addEventListener('click', ()=>{
      const idx = Number(b.dataset.idx);
      todos[idx].done = !todos[idx].done;
      saveTodos();
      closeModal();
      showDatePlans(dateISO);
    });
  });

  modal.querySelector('.close').onclick = closeModal;
  modal.querySelector('#closeModal').onclick = closeModal;
  function closeModal(){ if(modal){ modal.remove(); root.style.pointerEvents='none'; } }
}

document.getElementById('historyBtn').onclick = ()=>{
  const history = loadRoutineHistory();
  const mk = monthKey(todayISO());
  const modalRoot = document.getElementById('modalRoot'); modalRoot.style.pointerEvents='auto';
  const m = document.createElement('div'); m.className='modal'; m.id='historyModal';
  m.innerHTML = `<button class="close">‚úñ</button><h4>History Rutinitas per Bulan</h4>
    <div style="margin-top:8px;">
      <label>Pilih Bulan: <input type="month" id="histMonth" value="${mk}"></label>
    </div>
    <div id="histContent" style="max-height:50vh;overflow:auto;margin-top:10px;"></div>
    <div style="text-align:right;margin-top:10px;"><button id="closeHist" style="padding:6px 10px;border-radius:8px;border:0;background:var(--accent);color:#012b17;font-weight:700;">Close</button></div>`;
  modalRoot.appendChild(m);

  const histMonthInp = m.querySelector('#histMonth');
  const content = m.querySelector('#histContent');

  function renderHist(monthKeyVal){
    content.innerHTML = '';
    const data = history[monthKeyVal] || {};
    const routines = loadRoutines();
    if(Object.keys(data).length===0){ content.innerHTML = '<div class="small">Tidak ada history untuk bulan ini.</div>'; return; }
    const table = document.createElement('table'); table.style.width='100%'; table.style.borderCollapse='collapse';
    const thead = document.createElement('thead'); const thr = document.createElement('tr');
    thr.innerHTML = `<th style="padding:6px;">Tanggal</th>` + routines.map(r=>`<th style="padding:6px;">${r.text}</th>`).join('');
    thead.appendChild(thr); table.appendChild(thead);
    const tbody = document.createElement('tbody');
    Object.keys(data).sort().forEach(dateISO=>{
      const tr = document.createElement('tr');
      const rowCells = [`<td style="padding:6px;text-align:center">${dateISO}</td>`];
      routines.forEach(r=>{
        const v = data[dateISO] && data[dateISO][r.id] ? '‚úÖ' : '‚óªÔ∏è';
        rowCells.push(`<td style="padding:6px;text-align:center">${v}</td>`);
      });
      tr.innerHTML = rowCells.join('');
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    content.appendChild(table);
  }

  renderHist(histMonthInp.value);
  histMonthInp.addEventListener('change', ()=> renderHist(histMonthInp.value) );

  m.querySelector('.close').onclick = closeHist;
  m.querySelector('#closeHist').onclick = closeHist;
  function closeHist(){ m.remove(); modalRoot.style.pointerEvents='none'; }
};

/* ========== NEW FEATURES ========== */

/* Confetti Effect */
function triggerConfetti(){
  const canvas = document.getElementById('confetti');
  const ctx = canvas.getContext('2d');
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  
  const particles = [];
  const colors = ['#3fbf76', '#8fcfb0', '#2e8b57', '#9ad8b4'];
  
  for(let i=0; i<50; i++){
    particles.push({
      x: Math.random() * canvas.width,
      y: -20,
      vx: (Math.random() - 0.5) * 4,
      vy: Math.random() * 3 + 2,
      color: colors[Math.floor(Math.random() * colors.length)],
      size: Math.random() * 8 + 4
    });
  }
  
  function animate(){
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    let active = false;
    
    particles.forEach(p => {
      p.x += p.vx;
      p.y += p.vy;
      p.vy += 0.1;
      
      if(p.y < canvas.height){
        active = true;
        ctx.fillStyle = p.color;
        ctx.fillRect(p.x, p.y, p.size, p.size);
      }
    });
    
    if(active) requestAnimationFrame(animate);
    else ctx.clearRect(0, 0, canvas.width, canvas.height);
  }
  
  animate();
}

/* Pomodoro Timer */
let pomodoroTime = 25 * 60;
let pomodoroInterval = null;
let pomodoroRunning = false;

function updatePomodoroDisplay(){
  const mins = Math.floor(pomodoroTime / 60);
  const secs = pomodoroTime % 60;
  document.getElementById('pomodoroTimer').textContent = `${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`;
}

document.getElementById('pomodoroStart').onclick = ()=>{
  if(pomodoroRunning) return;
  pomodoroRunning = true;
  document.getElementById('pomodoroStatus').textContent = 'Focus time! üî•';
  pomodoroInterval = setInterval(()=>{
    pomodoroTime--;
    updatePomodoroDisplay();
    if(pomodoroTime <= 0){
      clearInterval(pomodoroInterval);
      pomodoroRunning = false;
      document.getElementById('pomodoroStatus').textContent = 'Time\'s up! Take a break üéâ';
      triggerConfetti();
      pomodoroTime = 25 * 60;
      updatePomodoroDisplay();
    }
  }, 1000);
};

document.getElementById('pomodoroPause').onclick = ()=>{
  if(pomodoroInterval){
    clearInterval(pomodoroInterval);
    pomodoroRunning = false;
    document.getElementById('pomodoroStatus').textContent = 'Paused';
  }
};

document.getElementById('pomodoroReset').onclick = ()=>{
  if(pomodoroInterval) clearInterval(pomodoroInterval);
  pomodoroRunning = false;
  pomodoroTime = 25 * 60;
  updatePomodoroDisplay();
  document.getElementById('pomodoroStatus').textContent = 'Ready to focus';
};

updatePomodoroDisplay();

/* Stats Mode */
function renderStats(){
  renderHeatmap();
  renderTopStreaks();
  renderProgressChart();
  renderCompletionRate();
}

function renderHeatmap(){
  const heatmap = document.getElementById('heatmap');
  heatmap.innerHTML = '';
  const history = loadRoutineHistory();
  const routines = loadRoutines();
  
  const today = new Date();
  for(let i = 27; i >= 0; i--){
    const date = new Date(today);
    date.setDate(date.getDate() - i);
    const dateISO = date.toISOString().slice(0,10);
    const mk = monthKey(dateISO);
    
    const dayData = (history[mk] && history[mk][dateISO]) || (i === 0 ? loadRoutineDay(dateISO) : {});
    const completed = Object.values(dayData).filter(v => v).length;
    const total = routines.length;
    
    let level = 0;
    if(total > 0){
      const ratio = completed / total;
      if(ratio >= 1) level = 4;
      else if(ratio >= 0.75) level = 3;
      else if(ratio >= 0.5) level = 2;
      else if(ratio > 0) level = 1;
    }
    
    const cell = document.createElement('div');
    cell.className = `heatmap-cell level-${level}`;
    cell.title = `${dateISO}: ${completed}/${total} completed`;
    heatmap.appendChild(cell);
  }
}

function renderTopStreaks(){
  const container = document.getElementById('topStreaks');
  const routines = loadRoutines();
  
  const streaks = routines.map(r => ({
    text: r.text,
    streak: computeStreak(r.id)
  })).sort((a,b) => b.streak - a.streak);
  
  if(streaks.length === 0){
    container.innerHTML = '<div class="small">No routines yet</div>';
    return;
  }
  
  container.innerHTML = streaks.slice(0, 5).map((s, i) => 
    `<div style="display:flex;justify-content:space-between;padding:8px;background:var(--card);border-radius:8px;margin-bottom:8px;">
      <div>${i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : 'üèÖ'} ${s.text}</div>
      <div style="font-weight:700;color:var(--accent);">${s.streak} days</div>
    </div>`
  ).join('');
}

function renderProgressChart(){
  const canvas = document.getElementById('progressChart');
  const ctx = canvas.getContext('2d');
  
  const routines = loadRoutines();
  const history = loadRoutineHistory();
  const today = todayISO();
  const mk = monthKey(today);
  const monthData = history[mk] || {};
  
  const labels = [];
  const data = [];
  
  for(let i = 6; i >= 0; i--){
    const date = new Date();
    date.setDate(date.getDate() - i);
    const dateISO = date.toISOString().slice(0,10);
    labels.push(date.toLocaleDateString('id-ID', {weekday: 'short'}));
    
    const dayData = i === 0 ? loadRoutineDay(dateISO) : (monthData[dateISO] || {});
    const completed = Object.values(dayData).filter(v => v).length;
    data.push(completed);
  }
  
  new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Completed Routines',
        data: data,
        borderColor: '#3fbf76',
        backgroundColor: '#3fbf7640',
        tension: 0.4,
        fill: true
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false }
      },
      scales: {
        y: { 
          beginAtZero: true,
          ticks: { color: '#8fcfb0' }
        },
        x: {
          ticks: { color: '#8fcfb0' }
        }
      }
    }
  });
}

function renderCompletionRate(){
  const routines = loadRoutines();
  const today = todayISO();
  const dayStatus = loadRoutineDay(today);
  
  if(routines.length === 0){
    document.getElementById('completionRate').textContent = '0%';
    return;
  }
  
  const completed = Object.values(dayStatus).filter(v => v).length;
  const rate = Math.round((completed / routines.length) * 100);
  document.getElementById('completionRate').textContent = `${rate}%`;
}

/* Focus Mode */
let focusTimer = 25 * 60;
let focusInterval = null;

function renderFocusMode(){
  const routines = loadRoutines();
  const today = todayISO();
  const dayStatus = loadRoutineDay(today);
  const list = document.getElementById('focusRoutineList');
  
  list.innerHTML = '';
  
  if(routines.length === 0){
    list.innerHTML = '<div class="small">No routines for today</div>';
    return;
  }
  
  routines.forEach(r => {
    const checked = !!dayStatus[r.id];
    const row = document.createElement('div');
    row.style.cssText = 'display:flex;align-items:center;gap:12px;padding:12px;background:var(--card);border-radius:10px;margin-bottom:10px;';
    row.innerHTML = `
      <input type="checkbox" data-focus-id="${r.id}" ${checked ? 'checked' : ''} style="width:20px;height:20px;">
      <div style="flex:1;font-size:1.1rem;">${r.text}</div>
    `;
    list.appendChild(row);
  });
  
  list.querySelectorAll('input[type="checkbox"]').forEach(cb => {
    cb.addEventListener('change', (e) => {
      const id = e.target.dataset.focusId;
      const val = e.target.checked;
      const day = loadRoutineDay(today);
      day[id] = !!val;
      saveRoutineDay(today, day);
      if(val) triggerConfetti();
      renderRoutinesUI();
      updateMonthSummary();
    });
  });
  
  pickQuote();
}

function updateFocusTimerDisplay(){
  const mins = Math.floor(focusTimer / 60);
  const secs = focusTimer % 60;
  document.getElementById('focusTimerDisplay').textContent = `${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`;
}

document.getElementById('focusStart').onclick = ()=>{
  if(focusInterval) return;
  focusInterval = setInterval(()=>{
    focusTimer--;
    updateFocusTimerDisplay();
    if(focusTimer <= 0){
      clearInterval(focusInterval);
      focusInterval = null;
      triggerConfetti();
      focusTimer = 25 * 60;
      updateFocusTimerDisplay();
    }
  }, 1000);
};

document.getElementById('focusReset').onclick = ()=>{
  if(focusInterval){
    clearInterval(focusInterval);
    focusInterval = null;
  }
  focusTimer = 25 * 60;
  updateFocusTimerDisplay();
};

updateFocusTimerDisplay();

/* Initialize */
dailyRolloverOnLoad();
buildCalendar();
renderTodos();
renderRoutinesUI();
updateMonthSummary();

window.addEventListener('beforeunload', ()=>{
  const today = todayISO();
  const st = loadRoutineDay(today);
  if(st && Object.keys(st).length) {
    const history = loadRoutineHistory();
    const mk = monthKey(today);
    if(!history[mk]) history[mk] = {};
    history[mk][today] = st;
    saveRoutineHistory(history);
  }
});

setInterval(()=>{
  if(todayISO() !== (JSON.parse(localStorage.getItem('lively_routines_meta_v1')||'{}').lastDate||'')){
    dailyRolloverOnLoad();
    buildCalendar();
    renderRoutinesUI();
    updateMonthSummary();
  }
}, 60*1000);

window._lively = { todos, loadRoutines, saveRoutines, loadRoutineHistory, archiveDay, buildCalendar, renderRoutinesUI, saveTodos };
</script>
</body>

</html>
